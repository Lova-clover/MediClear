<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>회원가입 | MediClear</title>
    <link rel="stylesheet" href="https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css">
    <link rel="stylesheet" href="style.css"/>
</head>
<body class="auth-page">
<div class="viewport">
    <main class="container auth-container">
        <div class="auth-card">
            <h1 class="app-title">회원가입</h1>
            <p class="app-subtitle">MediClear에 오신 것을 환영합니다.</p>
            <form id="register-form">
                <input id="reg-email" type="email" placeholder="이메일" inputmode="email" autocomplete="username" required/>
                <input id="reg-pass" type="password" placeholder="비밀번호" autocomplete="new-password" required/>

                <div class="role-selection">
                    <label class="role-card" data-role="patient">
                        <input type="radio" name="role" value="patient" required>
                        <div class="role-title">🙋 환자</div>
                        <div class="role-desc">나의 진료 및 처방 기록을 확인합니다.</div>
                    </label>
                    <label class="role-card" data-role="doctor">
                        <input type="radio" name="role" value="doctor">
                        <div class="role-title">🧑‍⚕️ 의사</div>
                        <div class="role-desc">환자의 기록 관리 및 처방을 내립니다.</div>
                    </label>
                </div>

                <button class="btn primary block" type="submit">가입하기</button>
            </form>
            <p class="helper-text">이미 계정이 있으신가요? <a href="login.html">로그인</a></p>
            <div id="reg-message" class="helper-text error-message"></div>
        </div>
    </main>
</div>

<script type="module">
    import { AppUX } from './app.js';

    document.querySelectorAll('.role-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            card.querySelector('input[type=radio]').checked = true;
        });
    });

     async function fetchJSON(url, options={}){
      const res = await fetch(url, { headers:{'Accept':'application/json', ...(options.headers||{})}, ...options });
      const raw = await res.text(); let data={}; try{ data = raw?JSON.parse(raw):{} }catch{ throw new Error(`서버 응답 형식 오류 (${res.status})`); }
      if(!res.ok) throw new Error(data.error||`요청 실패 (${res.status})`); return data;
    }

    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('reg-email').value.trim();
        const password = document.getElementById('reg-pass').value.trim();
        const role = document.querySelector('input[name="role"]:checked')?.value;
        const msg = document.getElementById('reg-message');
        msg.textContent = '';

        if (!role) {
            msg.textContent = '계정 유형을 선택해주세요.';
            return;
        }

        try {
            AppUX.loading(true);
            await fetchJSON('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, password, role})
            });
            location.replace('login.html');
        } catch (err) {
            msg.textContent = err.message;
            AppUX.toast('회원가입 실패');
        } finally {
            AppUX.loading(false);
        }
    });
</script>
</body>
</html>