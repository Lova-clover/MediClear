<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>íšŒì›ê°€ì… | MediClear</title>
    <link rel="stylesheet" href="https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css">
    <link rel="stylesheet" href="style.css"/>
</head>
<body class="auth-page">
<div class="viewport">
    <main class="container auth-container">
        <div class="auth-card">
            <h1 class="app-title">íšŒì›ê°€ì…</h1>
            <p class="app-subtitle">MediClearì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>
            <form id="register-form">
                <input id="reg-email" type="email" placeholder="ì´ë©”ì¼" inputmode="email" autocomplete="username" required/>
                <input id="reg-pass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="new-password" required/>

                <div class="role-selection">
                    <label class="role-card" data-role="patient">
                        <input type="radio" name="role" value="patient" required>
                        <div class="role-title">ğŸ™‹ í™˜ì</div>
                        <div class="role-desc">ë‚˜ì˜ ì§„ë£Œ ë° ì²˜ë°© ê¸°ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.</div>
                    </label>
                    <label class="role-card" data-role="doctor">
                        <input type="radio" name="role" value="doctor">
                        <div class="role-title">ğŸ§‘â€âš•ï¸ ì˜ì‚¬</div>
                        <div class="role-desc">í™˜ìì˜ ê¸°ë¡ ê´€ë¦¬ ë° ì²˜ë°©ì„ ë‚´ë¦½ë‹ˆë‹¤.</div>
                    </label>
                </div>

                <button class="btn primary block" type="submit">ê°€ì…í•˜ê¸°</button>
            </form>
            <p class="helper-text">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="login.html">ë¡œê·¸ì¸</a></p>
            <div id="reg-message" class="helper-text error-message"></div>
        </div>
    </main>
</div>

<script type="module">
    import { AppUX } from './app.js';

    document.querySelectorAll('.role-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            card.querySelector('input[type=radio]').checked = true;
        });
    });

     async function fetchJSON(url, options={}){
      const res = await fetch(url, { headers:{'Accept':'application/json', ...(options.headers||{})}, ...options });
      const raw = await res.text(); let data={}; try{ data = raw?JSON.parse(raw):{} }catch{ throw new Error(`ì„œë²„ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜ (${res.status})`); }
      if(!res.ok) throw new Error(data.error||`ìš”ì²­ ì‹¤íŒ¨ (${res.status})`); return data;
    }

    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('reg-email').value.trim();
        const password = document.getElementById('reg-pass').value.trim();
        const role = document.querySelector('input[name="role"]:checked')?.value;
        const msg = document.getElementById('reg-message');
        msg.textContent = '';

        if (!role) {
            msg.textContent = 'ê³„ì • ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
            return;
        }

        try {
            AppUX.loading(true);
            await fetchJSON('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, password, role})
            });
            location.replace('login.html');
        } catch (err) {
            msg.textContent = err.message;
            AppUX.toast('íšŒì›ê°€ì… ì‹¤íŒ¨');
        } finally {
            AppUX.loading(false);
        }
    });
</script>
</body>
</html>