<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ìˆ˜ìˆ  ì•ˆë‚´ | MediClear</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="viewport">
    <div class="app">
      <header class="app-header"><h1 class="app-title">ìˆ˜ìˆ  ì•ˆë‚´</h1></header>

      <main class="container">
        <section class="card">
          <h2 id="title">ìˆ˜ìˆ ëª…</h2>
          <p><strong>ìˆ˜ìˆ ì¼:</strong> <span id="date"></span></p>
        </section>

        <section class="card">
          <h2>ğŸ‘¨â€âš•ï¸ ì˜ì‚¬ ì›ë¬¸</h2>
          <div id="raw"></div>
        </section>

        <section class="card">
          <h2>ğŸ§¾ ì´í•´í•˜ê¸° ì‰¬ìš´ ì„¤ëª…</h2>
          <div id="easy"></div>
        </section>

        <section class="card">
          <h2>ğŸ“Œ í•´ì•¼ í•  ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
          <ul id="checklist"></ul>
        </section>
      </main>
    </div>
  </div>

  <script>
  const $ = (id)=>document.getElementById(id);
  function param(n){ return new URL(location.href).searchParams.get(n); }
  if ('serviceWorker' in navigator) { window.addEventListener('load', ()=>navigator.serviceWorker.register('./service-worker.js')); }

  async function fetchJSON(url, options={}){
    const res = await fetch(url, { headers:{'Accept':'application/json', ...(options.headers||{})}, ...options });
    const raw = await res.text(); let data={}; try{ data = raw ? JSON.parse(raw) : {}; }catch{ throw new Error(`ì„œë²„ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜ (${res.status})`); }
    if(!res.ok) throw new Error(data.error||`ìš”ì²­ ì‹¤íŒ¨ (${res.status})`); return data;
  }

  (async function(){
    const token = localStorage.getItem('token');
    const role  = localStorage.getItem('role');
    if(!token || role!=='patient'){ location.href='login.html'; return; }
    const id = param('id'); if(!id){ alert('ì˜ëª»ëœ ì ‘ê·¼'); location.href='mypage.html'; return; }

    try{
      const { surgery:s } = await fetchJSON('/api/surgery/'+encodeURIComponent(id), { headers:{ Authorization:'Bearer '+token }});
      $('title').textContent = s.title; $('date').textContent = s.date;
      $('raw').textContent   = s.raw;   $('easy').innerHTML = s.simplified.replace(/\n/g,'<br>');

      const list=[]; const T = s.simplified || '';
      if(/ê¸ˆì‹/i.test(T)) list.push('ìˆ˜ìˆ /ê²€ì‚¬ ì „ ê¸ˆì‹ ì§€í‚¤ê¸°');
      if(/í˜ˆì••.*ì¬/i.test(T)) list.push('ì§‘ì—ì„œ í˜ˆì•• ì¬ê¸°');
      if(/í•˜ë£¨ ë‘ ë²ˆ|1ì¼ 2íšŒ/i.test(T)) list.push('ì•„ì¹¨/ì €ë… ì•½ ë³µìš©');
      if(!list.length) list.push('ì˜ë£Œì§„ ì§€ì‹œ ë”°ë¥´ê¸°');
      $('checklist').innerHTML = list.map(x=>`<li>${x}</li>`).join('');
    }catch(e){ alert(e.message); location.href='mypage.html'; }
  })();
  </script>
</body>
</html>
