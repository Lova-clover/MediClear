<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>ë‚´ ì˜ë£Œ ì •ë³´ | MediClear</title>
    <link rel="stylesheet" href="https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css">
    <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="viewport">
    <div class="app">
        <header class="app-header">
            <h1 class="app-title">ë‚´ ì˜ë£Œ ì •ë³´</h1>
            <div class="app-actions">
                <button id="logout" class="btn-plain">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <main class="container">
            <section class="card profile-card">
                <div class="badge">í™˜ì</div>
                <h2 class="profile-title">ë‚´ í”„ë¡œí•„</h2>
                <div class="meta"><strong>ì´ë©”ì¼:</strong> <span id="profile-email"></span></div>
            </section>

            <div class="tabs" id="tabs">
                <button class="tab-btn active" data-tab="records">ğŸ“¢ ì§„ë‹¨</button>
                <button class="tab-btn" data-tab="schedules">ğŸ—“ ì¼ì •</button>
                <button class="tab-btn" data-tab="notes">ğŸ“ ë©”ëª¨</button>
            </div>

            <div data-page="records" class="tab-content active">
                <section class="card">
                    <h2>ì˜ì‚¬ ì§„ë‹¨ í™•ì¸</h2>
                    <ul id="records-list" class="list"></ul>
                </section>
            </div>

            <div data-page="schedules" class="tab-content">
                <section class="card">
                    <h2>ğŸ’Š ë³µì•½</h2>
                    <ul id="medication-list" class="list"></ul>
                </section>
                <section class="card">
                    <h2>ğŸ§ª ê²€ì‚¬</h2>
                    <ul id="test-list" class="list"></ul>
                </section>
                <section class="card">
                    <h2>ğŸ¥ ìˆ˜ìˆ </h2>
                    <ul id="surgery-list" class="list"></ul>
                </section>
            </div>

            <div data-page="notes" class="tab-content">
                <section class="card">
                    <h2>ë‚´ ê±´ê°• ë©”ëª¨</h2>
                    <form id="note-form" class="add-form">
                        <textarea id="note-content" placeholder="ì¦ìƒ, ê¶ê¸ˆí•œ ì ì„ ê¸°ë¡í•˜ì„¸ìš”." required></textarea>
                        <button class="btn block" type="submit">ë©”ëª¨ ì €ì¥</button>
                    </form>
                    <ul id="notes-list" class="list" style="margin-top:12px;"></ul>
                </section>
            </div>
        </main>
    </div>
</div>

  <script type="module">
    import { AppUX } from './app.js';
    const $ = id => document.getElementById(id);

    // ---- í† í°/ì—­í•  ----
    const token = localStorage.getItem('token') || '';
    const role  = localStorage.getItem('role')  || '';
    const email = localStorage.getItem('email') || '';
    if(!token || role!=='patient'){ location.replace('login.html'); }
    $('logout').addEventListener('click', AppUX.logout);
    $('profile-email').textContent = email || 'ì•Œ ìˆ˜ ì—†ìŒ';

    // ---- fetch ----
    async function fetchJSON(url, options={}){
      const res = await fetch(url, { headers:{ 'Accept':'application/json', Authorization:'Bearer '+token, ...(options.headers||{}) }, ...options });
      const raw = await res.text(); let data={}; try{ data = raw?JSON.parse(raw):{} }catch{ throw new Error(`ì„œë²„ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜ (${res.status})`); }
      if(!res.ok) throw new Error(data.error||`ìš”ì²­ ì‹¤íŒ¨ (${res.status})`); return data;
    }

    // ---- ìƒë‹¨ íƒ­ ì „í™˜(ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°) ----
    function activate(tab){
      document.querySelectorAll('[data-page]').forEach(el=> el.style.display = (el.dataset.page===tab)?'block':'none');
      document.querySelectorAll('.tabs button').forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
      AppUX.vibrate(6);
    }
    document.getElementById('tabs').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-tab]'); if(!btn) return; activate(btn.dataset.tab);
    });

    // ---- ì„œë²„ ë°ì´í„° ----
    async function loadRecords(){
      try{
        const r = await fetchJSON('/api/patient/records');
        $('records-list').innerHTML = (r.records||[]).length
          ? r.records.map(x=>`
              <li>
                <div class="meta">${x.date}</div>
                <div style="white-space:pre-line"><b>ì›ë¬¸</b>\n${(x.raw||'').trim()}</div>
                ${x.simplified ? `<div class="summary">${x.simplified}</div>` : ''}
              </li>`).join('')
          : '<li class="meta">ì§„ë‹¨ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
      }catch(e){ $('records-list').innerHTML = `<li class="meta">ì§„ë‹¨ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</li>`; }
    }
    async function loadSchedules(){
      try{
        const s = await fetchJSON('/api/patient/schedules');
        // ë³µì•½
        document.getElementById('medication-list').innerHTML = (s.medications||[]).length
          ? s.medications.map(m=>`<li>${m.time} Â· <strong>${m.name}</strong></li>`).join('')
          : '<li class="meta">ë³µì•½ ì¼ì • ì—†ìŒ</li>';
        // ê²€ì‚¬
        document.getElementById('test-list').innerHTML = (s.tests||[]).length
          ? s.tests.map(t=>`<li>${t.date} Â· <strong>${t.name}</strong></li>`).join('')
          : '<li class="meta">ê²€ì‚¬ ì¼ì • ì—†ìŒ</li>';
        // ğŸ†• ìˆ˜ìˆ 
        const surgEl = document.getElementById('surgery-list');
        if (surgEl){
          surgEl.innerHTML = (s.surgeries||[]).length
            ? s.surgeries.map(x=>`<li>${x.date} Â· <strong>${x.title}</strong></li>`).join('')
            : '<li class="meta">ìˆ˜ìˆ  ì¼ì • ì—†ìŒ</li>';
        }
      }catch(e){
        document.getElementById('medication-list').innerHTML = `<li class="meta">ë³µì•½ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</li>`;
        document.getElementById('test-list').innerHTML       = `<li class="meta">ê²€ì‚¬ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</li>`;
        const surgEl = document.getElementById('surgery-list');
        if (surgEl) surgEl.innerHTML = `<li class="meta">ìˆ˜ìˆ  ë¡œë“œ ì‹¤íŒ¨: ${e.message}</li>`;
      }
    }


    // ---- ë¡œì»¬ ë©”ëª¨ (ì‚¬ìš©ìë³„ í‚¤ë¡œ ìœ ì§€) ----
    const NOTES_KEY = email ? `mediclear_notes_${email}` : 'mediclear_notes';
    try{
      const legacy = localStorage.getItem('mediclear_notes');
      if(legacy && !localStorage.getItem(NOTES_KEY)){ localStorage.setItem(NOTES_KEY, legacy); localStorage.removeItem('mediclear_notes'); }
    }catch{}
    function readNotes(){ try{ return JSON.parse(localStorage.getItem(NOTES_KEY)||'[]'); }catch{ return []; } }
    function writeNotes(list){ localStorage.setItem(NOTES_KEY, JSON.stringify(list)); }
    function renderNotes(){
      const list = readNotes();
      $('notes-list').innerHTML = list.length ? list.map(n=>`
        <li data-id="${n.id}">
          <div class="meta">${n.ts}</div>
          <div style="margin:6px 0; white-space:pre-line">${n.content}</div>
          <div class="field-row" style="margin-top:6px;">
            <button class="btn sm" data-action="edit">ìˆ˜ì •</button>
            <button class="btn sm danger" data-action="delete">ì‚­ì œ</button>
          </div>
          <div class="card" style="margin-top:8px; display:none;" data-box="edit">
            <textarea rows="3">${n.content}</textarea>
            <div class="field-row" style="margin-top:8px;">
              <button class="btn sm" data-action="save">ì €ì¥</button>
              <button class="btn sm ghost" data-action="cancel">ì·¨ì†Œ</button>
            </div>
          </div>
        </li>`).join('') : '<li class="meta" style="text-align:center;">ì²« ë©”ëª¨ë¥¼ ì‘ì„±í•´ ë³´ì„¸ìš”!</li>';
    }
    document.getElementById('note-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const content = document.getElementById('note-content').value.trim();
      if(!content) return AppUX.toast('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
      const list = readNotes();
      list.unshift({ id: Date.now().toString(36), ts: new Date().toLocaleString(), content });
      writeNotes(list);
      document.getElementById('note-content').value='';
      renderNotes();
      AppUX.toast('ë©”ëª¨ ì €ì¥ë¨');
    });
    document.getElementById('notes-list').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]'); if(!btn) return;
      const li = btn.closest('li'), id = li.dataset.id;
      const list = readNotes();
      const idx = list.findIndex(x=>x.id===id);
      const editBox = li.querySelector('[data-box="edit"]');
      if(idx<0) return;
      if(btn.dataset.action==='delete'){
        AppUX.openSheet(`
        <div style="
          max-width:420px;   /* ì•± ì¹´ë“œ ìµœëŒ€ í­ ì œí•œ */
          margin:0 auto;     /* ê°€ìš´ë° ì •ë ¬ */
          text-align:center;
        ">
          <h3 style="margin:0 0 12px; font-size:16px;">ë©”ëª¨ë¥¼ ì‚­ì œí• ê¹Œìš”?</h3>
          <div style="display:flex; justify-content:center; gap:12px; margin-top:8px;">
            <button id="do-del" class="btn danger sm" style="width:auto; padding:6px 14px;">ì‚­ì œ</button>
            <button id="cancel-del" class="btn ghost sm" style="width:auto; padding:6px 14px;">ì·¨ì†Œ</button>
          </div>
        </div>
      `);

        document.getElementById('do-del').onclick = ()=>{ list.splice(idx,1); writeNotes(list); renderNotes(); AppUX.closeSheet(); AppUX.toast('ì‚­ì œë¨'); };
        document.getElementById('cancel-del').onclick = AppUX.closeSheet;
      }
      if(btn.dataset.action==='edit'){ editBox.style.display = editBox.style.display==='none' ? 'block' : 'none'; }
      if(btn.dataset.action==='cancel'){ editBox.style.display='none'; }
      if(btn.dataset.action==='save'){
        const val = editBox.querySelector('textarea').value.trim();
        if(!val) return AppUX.toast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
        list[idx].content = val; writeNotes(list); renderNotes(); AppUX.toast('ì €ì¥ë¨');
      }
    });

    // ì´ˆê¸° ë¡œë“œ
    activate('records');
    await Promise.all([loadRecords(), loadSchedules()]);
    renderNotes();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', ()=>navigator.serviceWorker.register('./service-worker.js'));
    }
  </script>
</body>
</html>
