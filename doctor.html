<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>ì˜ì‚¬ ëŒ€ì‹œë³´ë“œ | MediClear</title>
    <link rel="stylesheet" href="https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css">
    <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="viewport">
    <div class="app">
        <header class="app-header">
            <h1 class="app-title">ì˜ì‚¬ ëŒ€ì‹œë³´ë“œ</h1>
            <div class="app-actions">
                <button id="logout" class="btn-plain">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <main class="container">
            <div class="tabs" id="tabs">
                <button class="tab-btn active" data-tab="order">ğŸ©º ì§„ë‹¨</button>
                <button class="tab-btn" data-tab="surgery">ğŸ¥ ìˆ˜ìˆ </button>
                <button class="tab-btn" data-tab="schedule">ğŸ•’ ì¼ì •</button>
            </div>

            <div data-page="order" class="tab-content active">
                <section class="card">
                    <h2>í™˜ì ì§„ë‹¨ ë“±ë¡</h2>
                    <form id="doctor-form" class="add-form">
                        <input type="email" id="patient-email" placeholder="í™˜ì ì´ë©”ì¼" required inputmode="email"/>
                        <textarea id="instruction" placeholder="ì›ë¬¸ ì§„ë‹¨/ì§€ì‹œë¥¼ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
                        <button class="btn block" type="submit">ì§„ë‹¨ ë“±ë¡</button>
                    </form>
                </section>
                <section class="card">
                    <h2>ì§„ë‹¨ ê¸°ë¡ ì¡°íšŒ</h2>
                    <div class="field-row">
                        <input type="email" id="filter-patient" placeholder="í™˜ì ì´ë©”ì¼(ì„ íƒ)"/>
                        <button id="refresh" class="btn sm ghost" type="button">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <ul id="doctor-records" class="list" style="margin-top:12px;"></ul>
                </section>
            </div>

            <div data-page="surgery" class="tab-content">
                <section class="card">
                    <h2>ìˆ˜ìˆ  ë“±ë¡</h2>
                    <form id="surgery-form" class="add-form">
                        <input type="email" id="surg-patient" placeholder="í™˜ì ì´ë©”ì¼" required inputmode="email"/>
                        <input type="text"  id="surg-title"   placeholder="ìˆ˜ìˆ ëª… (ì˜ˆ: ë°±ë‚´ì¥)" required/>
                        <input type="date"  id="surg-date"    required/>
                        <textarea id="surg-notes" placeholder="ìˆ˜ìˆ /ì „í›„ ì§€ì‹œ ë©”ëª¨ (ì›ë¬¸)"></textarea>
                        <button class="btn block" type="submit">ìˆ˜ìˆ  ë“±ë¡</button>
                    </form>
                </section>
                <section class="card">
                    <h2>ìˆ˜ìˆ  ê¸°ë¡ ì¡°íšŒ</h2>
                    <div class="field-row">
                        <input type="email" id="filter-patient2" placeholder="í™˜ì ì´ë©”ì¼(ì„ íƒ)"/>
                        <button id="refresh2" class="btn sm ghost" type="button">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <ul id="surgery-list" class="list" style="margin-top:12px;"></ul>
                </section>
            </div>

            <div data-page="schedule" class="tab-content">
                <section class="card">
                    <h2>ì¼ì • ë“±ë¡</h2>
                    <details class="acc" open>
                        <summary>ğŸ’Š ë³µì•½ ì¶”ê°€</summary>
                        <div class="acc-body">
                            <form id="med-form" class="add-form">
                                <input id="med-email" type="email" placeholder="í™˜ì ì´ë©”ì¼" required>
                                <input id="med-name"  type="text"  placeholder="ì•½ ì´ë¦„" required>
                                <input id="med-time" type="datetime-local" required>
                                <button class="btn block" type="submit">ë³µì•½ ì¶”ê°€</button>
                            </form>
                        </div>
                    </details>
                    <details class="acc">
                        <summary>ğŸ§ª ê²€ì‚¬ ì¶”ê°€</summary>
                        <div class="acc-body">
                            <form id="test-form" class="add-form">
                                <input id="test-email" type="email" placeholder="í™˜ì ì´ë©”ì¼" required>
                                <input id="test-name"  type="text"  placeholder="ê²€ì‚¬ëª…" required>
                                <input id="test-date" type="date" required>
                                <button class="btn block" type="submit">ê²€ì‚¬ ì¶”ê°€</button>
                            </form>
                        </div>
                    </details>
                </section>
                <section class="card">
                    <h2>í™˜ì ì¼ì • ì¡°íšŒ</h2>
                     <div class="field-row">
                        <input id="sched-patient" type="email" placeholder="í™˜ì ì´ë©”ì¼ ì…ë ¥">
                        <button id="load-patient-schedules" class="btn sm" type="button">ì¡°íšŒ</button>
                    </div>

                    <h3 class="list-title">ë³µì•½ ëª©ë¡</h3>
                    <ul id="med-list-admin" class="list"></ul>
                    <h3 class="list-title">ê²€ì‚¬ ëª©ë¡</h3>
                    <ul id="test-list-admin" class="list"></ul>
                    <h3 class="list-title">ìˆ˜ìˆ  ëª©ë¡</h3>
                    <ul id="surgery-list-admin" class="list"></ul>
                </section>
            </div>
        </main>
    </div>
</div>

  <script type="module">
    import { AppUX } from './app.js';
    const $ = id=>document.getElementById(id);

    const token = localStorage.getItem('token') || '';
    const role  = localStorage.getItem('role')  || '';
    if (!token || !(role==='doctor' || role==='admin')) {
      localStorage.removeItem('token'); location.replace('login.html');
    }
    $('logout').addEventListener('click', AppUX.logout);

    async function fetchJSON(url, options={}){
      const res = await fetch(url, { ...options, headers:{ 'Accept':'application/json','Authorization':'Bearer '+token, ...(options.headers||{}) } });
      const txt = await res.text(); let data={}; try{ data = txt?JSON.parse(txt):{} }catch{}
      if(!res.ok){
        const code = data?.error||'';
        if(res.status===401 || code==='NO_TOKEN' || code==='INVALID_TOKEN'){ localStorage.removeItem('token'); location.replace('login.html'); }
        throw new Error(code || `ìš”ì²­ ì‹¤íŒ¨ (${res.status})`);
      }
      return data;
    }

    function activate(tab){
      document.querySelectorAll('[data-page]').forEach(el=> el.style.display = (el.dataset.page===tab)?'block':'none');
      document.querySelectorAll('.tabs button').forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
      AppUX.vibrate(6);
    }
    document.getElementById('tabs').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-tab]'); if(!btn) return; activate(btn.dataset.tab);
    });

    // ---- ì§„ë‹¨ ----
    $('doctor-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('patient-email').value.trim();
      const instruction = $('instruction').value.trim();
      if(!email || !instruction) return AppUX.toast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
      try{
        AppUX.loading(true);
        await fetchJSON('/api/doctor', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, instruction }) });
        AppUX.toast('ì§„ë‹¨ ë“±ë¡ ì„±ê³µ'); $('instruction').value=''; loadDoctorRecords(); activate('order');
      }catch(err){ AppUX.toast('ë“±ë¡ ì‹¤íŒ¨: '+err.message); }
      finally{ AppUX.loading(false); }
    });
    async function loadDoctorRecords(){
      const email = $('filter-patient').value?.trim();
      try{
        const data = await fetchJSON('/api/doctor/records' + (email ? `?patient=${encodeURIComponent(email)}` : ''));
        const ul = $('doctor-records');
        ul.innerHTML = (data.records||[]).length ? '' : '<li class="meta">ì§„ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        (data.records||[]).forEach(r=>{
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="meta">${(r.ts||'').slice(0,16).replace('T',' ')} Â· <b>${r.patient_email||''}</b></div>
            <div style="margin-top:4px;white-space:pre-line;color:#334155;"><b>ì›ë¬¸</b>\n${r.raw||''}</div>
            ${r.simplified ? `<div class="summary">${r.simplified}</div>` : ''}
          `;
          ul.appendChild(li);
        });
      }catch(err){ AppUX.toast('ì§„ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+err.message); }
    }
    $('refresh').addEventListener('click', loadDoctorRecords);

    // ---- ìˆ˜ìˆ  ----
    $('surgery-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('surg-patient').value.trim();
      const title = $('surg-title').value.trim();
      const date  = $('surg-date').value;
      const notes = $('surg-notes').value.trim();
      if(!email || !title || !date) return AppUX.toast('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
      try{
        AppUX.loading(true);
        await fetchJSON('/api/doctor/surgery', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, title, date, notes }) });
        AppUX.toast('ìˆ˜ìˆ  ë“±ë¡ ì™„ë£Œ');
        ['surg-title','surg-date','surg-notes'].forEach(id=>document.getElementById(id).value='');
        loadSurgeries();
        // ğŸ†• ì¼ì • í™”ë©´ë„ ì¦‰ì‹œ ë°˜ì˜
        if($('sched-patient').value.trim()===email) await loadSchedulesFor(email);
        activate('surgery');
      }catch(err){ AppUX.toast('ë“±ë¡ ì‹¤íŒ¨: '+err.message); }
      finally{ AppUX.loading(false); }
    });
    async function loadSurgeries(){
      const email = $('filter-patient2').value?.trim();
      try{
        const data = await fetchJSON('/api/doctor/surgeries' + (email ? `?patient=${encodeURIComponent(email)}` : ''));
        const ul = $('surgery-list');
        ul.innerHTML = (data.surgeries||[]).length ? '' : '<li class="meta">ìˆ˜ìˆ  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        (data.surgeries||[]).forEach(s=>{
          const li = document.createElement('li');
          li.innerHTML = `
            <div><b>${s.patient_email}</b> Â· ${s.date} Â· <strong>${s.title}</strong></div>
            ${s.notes ? `<div class="meta" style="white-space:pre-line">${s.notes}</div>`:''}
            ${s.simplified ? `<div class="summary">${s.simplified}</div>` : ''}
          `;
          ul.appendChild(li);
        });
      }catch(err){ AppUX.toast('ìˆ˜ìˆ  ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+err.message); }
    }
    $('refresh2').addEventListener('click', loadSurgeries);

    // ---- ì¼ì • ë“±ë¡/ì¡°íšŒ ----
    $('med-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('med-email').value.trim();
      const name  = $('med-name').value.trim();
      const time  = $('med-time').value;
      if(!email || !name || !time) return AppUX.toast('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
      try{
        AppUX.loading(true);
        await fetchJSON('/api/doctor/medication', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, name, time }) });
        e.target.reset(); AppUX.toast('ë³µì•½ ì¼ì • ë“±ë¡');
        if($('sched-patient').value.trim()===email) await loadSchedulesFor(email);
        activate('schedule');
      }catch(err){ AppUX.toast('ë³µì•½ ë“±ë¡ ì‹¤íŒ¨: '+err.message); }
      finally{ AppUX.loading(false); }
    });
    $('test-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('test-email').value.trim();
      const name  = $('test-name').value.trim();
      const date  = $('test-date').value;
      if(!email || !name || !date) return AppUX.toast('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
      try{
        AppUX.loading(true);
        await fetchJSON('/api/doctor/test', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, name, date }) });
        e.target.reset(); AppUX.toast('ê²€ì‚¬ ì¼ì • ë“±ë¡');
        if($('sched-patient').value.trim()===email) await loadSchedulesFor(email);
        activate('schedule');
      }catch(err){ AppUX.toast('ê²€ì‚¬ ë“±ë¡ ì‹¤íŒ¨: '+err.message); }
      finally{ AppUX.loading(false); }
    });

    async function loadSchedulesFor(email) {
        try {
            const data = await fetchJSON('/api/doctor/schedules?patient=' + encodeURIComponent(email));
            
            $('med-list-admin').innerHTML = (data.medications || []).length ?
                data.medications.map(m => `
                    <li data-id="${m.id}" data-type="med">
                        <div>
                            <span><div class="meta">${m.time}</div><strong>${m.name}</strong></span>
                            <span class="list-item-actions">
                                <button class="btn sm ghost" data-action="edit">ìˆ˜ì •</button>
                                <button class="btn sm danger" data-action="delete">ì‚­ì œ</button>
                            </span>
                        </div>
                    </li>`).join('') :
                '<li class="meta">ë³µì•½ ì—†ìŒ</li>';

            $('test-list-admin').innerHTML = (data.tests || []).length ?
                data.tests.map(t => `
                    <li data-id="${t.id}" data-type="test">
                        <div>
                           <span><div class="meta">${t.date}</div><strong>${t.name}</strong></span>
                           <span class="list-item-actions">
                                <button class="btn sm ghost" data-action="edit">ìˆ˜ì •</button>
                                <button class="btn sm danger" data-action="delete">ì‚­ì œ</button>
                            </span>
                        </div>
                    </li>`).join('') :
                '<li class="meta">ê²€ì‚¬ ì—†ìŒ</li>';
            
            $('surgery-list-admin').innerHTML = (data.surgeries || []).length ?
                data.surgeries.map(s => `<li><div class="meta">${s.date}</div><div><strong>${s.title}</strong></div></li>`).join('') :
                '<li class="meta">ìˆ˜ìˆ  ì—†ìŒ</li>';

        } catch (err) { AppUX.toast('ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + err.message); }
    }

    $('load-patient-schedules').addEventListener('click', () => {
        const email = $('sched-patient').value.trim();
        if (!email) return AppUX.toast('í™˜ì ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”');
        loadSchedulesFor(email);
    });
    
    // ---- ì¼ì • ìˆ˜ì •/ì‚­ì œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ----
    async function handleScheduleAction(e) {
        const button = e.target.closest('button[data-action]');
        if (!button) return;

        const li = button.closest('li');
        const id = li.dataset.id;
        const type = li.dataset.type; // 'med' or 'test'
        const action = button.dataset.action;
        const patientEmail = $('sched-patient').value.trim();

        if (action === 'delete') {
            if (confirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await fetchJSON(`/api/doctor/${type === 'med' ? 'medication' : 'test'}/${id}`, { method: 'DELETE' });
                    AppUX.toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadSchedulesFor(patientEmail);
                } catch (err) {
                    AppUX.toast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
                }
            }
        } else if (action === 'edit') {
            if (type === 'med') {
                const newName = prompt('ìƒˆ ì•½ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', li.querySelector('strong').textContent);
                const newTime = prompt('ìƒˆ ë³µì•½ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DDTHH:MM):', li.querySelector('.meta').textContent);
                if (newName && newTime) {
                    try {
                        await fetchJSON(`/api/doctor/medication/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: newName, time: newTime })
                        });
                        AppUX.toast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadSchedulesFor(patientEmail);
                    } catch (err) {
                        AppUX.toast('ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
                    }
                }
            } else if (type === 'test') {
                const newName = prompt('ìƒˆ ê²€ì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', li.querySelector('strong').textContent);
                const newDate = prompt('ìƒˆ ê²€ì‚¬ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):', li.querySelector('.meta').textContent);
                 if (newName && newDate) {
                    try {
                        await fetchJSON(`/api/doctor/test/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: newName, date: newDate })
                        });
                        AppUX.toast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadSchedulesFor(patientEmail);
                    } catch (err) {
                        AppUX.toast('ìˆ˜ì • ì‹¤íŒ¨: ' + err.message);
                    }
                }
            }
        }
    }

    $('med-list-admin').addEventListener('click', handleScheduleAction);
    $('test-list-admin').addEventListener('click', handleScheduleAction);


    // ì´ˆê¸° ë¡œë“œ
    activate('order');
    loadDoctorRecords();
    loadSurgeries();
</script>
</body>
</html>